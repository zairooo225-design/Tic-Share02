<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Private Cloud</title>
  
  <!-- Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    /* 2025 Aesthetics Setup */
    body {
      margin: 0;
      background: #000;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
      touch-action: manipulation; /* Improves touch response on mobile */
      /* Selection color for that premium feel */
      --selection-bg: #fff;
      --selection-text: #000;
    }

    ::selection { background: var(--selection-bg); color: var(--selection-text); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes scaleOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.95); opacity: 0; } }
    
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.1); } 50% { box-shadow: 0 0 40px rgba(255,255,255,0.3); } }
    
    /* Converter Animations */
    @keyframes scanline { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    @keyframes textPulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .animate-fade-out { animation: fadeOut 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    
    .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .animate-slide-down { animation: slideDown 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    
    .animate-scale-in { animation: scaleIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .animate-scale-out { animation: scaleOut 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    
    .animate-float { animation: float 6s ease-in-out infinite; }
    .animate-glow { animation: glow 3s ease-in-out infinite; }

    .animate-scan { animation: scanline 2.5s linear infinite; }
    .animate-text-pulse { animation: textPulse 1.5s ease-in-out infinite; }

    /* Utility Classes for Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .glass-card {
      background: rgba(20, 20, 20, 0.6);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .input-field {
      /* Specifically forcing black text for password bullets */
      color: black !important;
      background: white;
      transition: all 0.3s ease;
    }
    .input-field:focus {
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .hover-trigger { transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .hover-trigger:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIGURATION ---
    const CONFIG = {
      ITSHARE_URL: "https://imgur.com/a/3bfKVnz",
      ITSHARE_LOADING_IMAGE_URL: "https://i.imgur.com/4BEr3zO.png",
      LOBBY_IMAGE_URL: "https://i.imgur.com/pGB9giE.png",
      SPECIAL_KEY: '1233',
      MAX_NAME_LENGTH: 20,
    };

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBwkx6FZv_pcJr1xkWZ7AvjkPxZxdM2_3g",
      authDomain: "tic-share.firebaseapp.com",
      databaseURL: "https://tic-share-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tic-share",
      storageBucket: "tic-share.firebasestorage.app",
      messagingSenderId: "694169491730",
      appId: "1:694169491730:web:7ac8f7c82cdf471fcffbcb"
    };

    const DEFAULT_USERS = {
      user1: { name: 'Zairo', password: 'zairo123', icon: 'https://via.placeholder.com/150/FFFFFF/000000?text=Z' },
      user2: { name: 'stan și bran realitatea plus ❤', password: 'stan123', icon: 'https://via.placeholder.com/150/FFFFFF/000000?text=S' }
    };

    // --- SERVICES ---
    const initFirebase = () => {
      if (window.firebase && !window.firebase.apps.length) {
        window.firebase.initializeApp(FIREBASE_CONFIG);
      }
    };

    const saveData = async (path, data) => {
      try {
        await window.firebase.database().ref(path).set(data);
      } catch (error) {
        console.error(`Error saving to ${path}:`, error);
      }
    };

    // --- HOOKS ---
    // Hook to allow animation to finish before unmounting
    const useDelayUnmount = (isMounted, delayTime) => {
      const [shouldRender, setShouldRender] = useState(false);

      useEffect(() => {
        let timeoutId;
        if (isMounted && !shouldRender) {
          setShouldRender(true);
        } else if (!isMounted && shouldRender) {
          timeoutId = setTimeout(() => setShouldRender(false), delayTime);
        }
        return () => clearTimeout(timeoutId);
      }, [isMounted, delayTime, shouldRender]);

      return shouldRender;
    };

    // --- ICONS ---
    const Icons = {
      Upload: () => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className="w-full h-full"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
      Download: ({ className = "w-5 h-5" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      X: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      User: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      Message: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
      File: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
      LogOut: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      Edit: ({ className = "w-5 h-5" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      ArrowLeft: ({ className = "w-6 h-6" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
      Warning: ({ className = "w-16 h-16" }) => <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    };

    // --- COMPONENTS ---
    const Notification = ({ notification }) => {
      const shouldRender = useDelayUnmount(notification.show, 300);
      if (!shouldRender) return null;

      const animationClass = notification.show ? 'animate-slide-down' : 'animate-fade-out';

      return (
        <div className={`fixed top-8 right-8 z-[9999] px-6 py-4 rounded-2xl font-bold shadow-[0_0_30px_rgba(0,0,0,0.5)] transform transition-all duration-300 backdrop-blur-md ${animationClass} ${
          notification.type === 'success' 
            ? 'bg-white text-black border border-green-500' 
            : 'bg-white text-black border border-red-500'
        }`}>
          <div className="flex items-center gap-4">
            <span className="text-2xl">{notification.type === 'success' ? '✨' : '⚠️'}</span>
            <p className="tracking-wide">{notification.message}</p>
          </div>
        </div>
      );
    };

    const ModalBackdrop = ({ show, onClose, children }) => {
      const shouldRender = useDelayUnmount(show, 400); // 400ms to allow exit animation
      
      if (!shouldRender) return null;

      const containerClass = show ? 'animate-fade-in' : 'animate-fade-out';
      const contentClass = show ? 'animate-scale-in' : 'animate-scale-out';

      return (
        <div className={`fixed inset-0 bg-black/80 backdrop-blur-xl flex items-center justify-center z-[9999] p-4 ${containerClass}`} onClick={onClose}>
          <div className={`glass-card rounded-[2.5rem] p-8 md:p-10 shadow-2xl max-w-md w-full relative overflow-hidden ${contentClass}`} onClick={e => e.stopPropagation()}>
            {/* Ambient light inside modal */}
            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-[50px]"></div>
            {children}
          </div>
        </div>
      );
    };

    const ConfirmationModal = ({ show, title, message, confirmText, cancelText = "Cancel", onConfirm, onCancel, isDanger = false }) => (
      <ModalBackdrop show={show} onClose={onCancel}>
        <div className="text-center mb-8 relative z-10">
          <div className="flex justify-center mb-6 text-white">
            <Icons.Warning className="w-20 h-20 animate-float" />
          </div>
          <h2 className="text-3xl font-black text-white mb-4 tracking-tight">{title}</h2>
          <p className="text-gray-300 font-medium leading-relaxed">{message}</p>
        </div>
        <div className="flex gap-4">
          <button 
            onClick={onConfirm} 
            className={`flex-1 rounded-2xl py-4 font-bold transition-all transform hover:scale-105 hover:shadow-lg ${
              isDanger 
                ? 'bg-red-600 text-white hover:bg-red-500 shadow-red-600/30' 
                : 'bg-white text-black hover:bg-gray-200 shadow-white/20'
            }`}
          >
            {confirmText}
          </button>
          <button 
            onClick={onCancel} 
            className="flex-1 bg-transparent border-2 border-white/20 text-white rounded-2xl py-4 font-bold hover:bg-white/10 hover:border-white/40 transition-all transform hover:scale-105"
          >
            {cancelText}
          </button>
        </div>
      </ModalBackdrop>
    );

    // --- MAIN APP ---
    const App = () => {
      const [view, setView] = useState('loading');
      const [currentUser, setCurrentUser] = useState(null);
      const [selectedUser, setSelectedUser] = useState(null);
      const [users, setUsers] = useState(DEFAULT_USERS);
      const [files, setFiles] = useState({});
      const [notes, setNotes] = useState([]);
      
      const [loginPassword, setLoginPassword] = useState('');
      const [showPasswordReset, setShowPasswordReset] = useState(false);
      const [resetKey, setResetKey] = useState('');
      const [resetUserId, setResetUserId] = useState(null);
      const [newPasswordReset, setNewPasswordReset] = useState('');
      const [confirmPasswordReset, setConfirmPasswordReset] = useState('');
      
      const [notification, setNotification] = useState({ show: false, message: '', type: '' });
      const [showStorageWarning, setShowStorageWarning] = useState(false);
      const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleteTarget, setDeleteTarget] = useState({ type: '', id: null });
      const [deleteStep, setDeleteStep] = useState(1);
      const [showITShareLoading, setShowITShareLoading] = useState(false);
      
      const [editingProfile, setEditingProfile] = useState(false);
      const [tempProfile, setTempProfile] = useState({ name: '', icon: '' });
      const [changingPassword, setChangingPassword] = useState(false);
      const [passwordChange, setPasswordChange] = useState({ current: '', new: '', confirm: '' });
      const [newNote, setNewNote] = useState('');
      const [editingNote, setEditingNote] = useState(null);
      const [editNoteText, setEditNoteText] = useState('');

      useEffect(() => {
        initFirebase();
        const hasLoaded = sessionStorage.getItem('hasLoadedOnce');
        const sessionUser = sessionStorage.getItem('currentUser');
        
        if (sessionUser) {
          setCurrentUser(sessionUser);
          loadFromFirebase();
          setView('files');
        } else if (!hasLoaded) {
          setTimeout(() => {
            loadFromFirebase();
            sessionStorage.setItem('hasLoadedOnce', 'true');
            setTimeout(() => setView('login'), 500);
          }, 2500);
        } else {
          loadFromFirebase();
          setView('login');
        }
      }, []);

      useEffect(() => {
        if (currentUser) checkStorageUsage();
      }, [currentUser, files]);

      const showNotif = (message, type) => {
        setNotification({ show: true, message, type });
        setTimeout(() => setNotification({ show: false, message: '', type: '' }), 3000);
      };

      const loadFromFirebase = async () => {
        try {
          const db = window.firebase.database();
          const [uSnap, fSnap, nSnap] = await Promise.all([
            db.ref('users').once('value'),
            db.ref('files').once('value'),
            db.ref('notes').once('value')
          ]);
          if (uSnap.exists()) setUsers(uSnap.val());
          if (fSnap.exists()) setFiles(fSnap.val());
          if (nSnap.exists()) setNotes(Object.values(nSnap.val()));
        } catch (e) { console.error("Firebase load error", e); }
      };

      const checkStorageUsage = () => {
        if (!currentUser) return;
        const userFiles = files[currentUser] || [];
        const totalBytes = userFiles.reduce((acc, file) => acc + file.size, 0);
        if ((totalBytes / (1024 * 1024 * 1024)) >= 0.80) setShowStorageWarning(true);
      };

      const handleLogin = () => {
        if (!selectedUser) return;
        if (users[selectedUser].password === loginPassword) {
          setCurrentUser(selectedUser);
          sessionStorage.setItem('currentUser', selectedUser);
          setView('files');
          setLoginPassword('');
          setSelectedUser(null);
          showNotif('Access Granted', 'success');
        } else {
          showNotif('Access Denied', 'error');
        }
      };

      const handleLogout = () => {
        setCurrentUser(null);
        sessionStorage.removeItem('currentUser');
        setView('login');
        setShowLogoutConfirm(false);
      };

      const handleFileUpload = (e) => {
        if (!currentUser || !e.target.files?.[0]) return;
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async (ev) => {
          const newFile = {
            id: Date.now(),
            name: file.name,
            type: file.type,
            size: file.size,
            data: ev.target?.result,
            uploadDate: new Date().toISOString()
          };
          const uFiles = files[currentUser] || [];
          const updated = { ...files, [currentUser]: [...uFiles, newFile] };
          setFiles(updated);
          await saveData('files', updated);
          showNotif('Upload Complete', 'success');
        };
        reader.readAsDataURL(file);
      };

      const handleDeleteRequest = (type, id) => {
        setDeleteTarget({ type, id });
        setDeleteStep(1);
        setShowDeleteConfirm(true);
      };

      const proceedDelete = async () => {
        if (deleteStep === 1) { setDeleteStep(2); return; }
        if (!currentUser || !deleteTarget.id) return;

        if (deleteTarget.type === 'file') {
          const uFiles = files[currentUser] || [];
          const updated = { ...files, [currentUser]: uFiles.filter(f => f.id !== deleteTarget.id) };
          setFiles(updated);
          await saveData('files', updated);
        } else if (deleteTarget.type === 'note') {
          const updated = notes.filter(n => n.id !== deleteTarget.id);
          setNotes(updated);
          await saveData('notes', updated);
        }
        showNotif('Item Erased', 'success');
        setShowDeleteConfirm(false);
        setDeleteTarget({ type: '', id: null });
        setDeleteStep(1);
      };

      const handleAddNote = async () => {
        if (!currentUser || !newNote.trim()) return;
        const note = {
          id: Date.now(),
          userId: currentUser,
          user: users[currentUser].name,
          text: newNote,
          date: new Date().toISOString()
        };
        const updated = [note, ...notes];
        setNotes(updated);
        setNewNote('');
        await saveData('notes', updated);
        showNotif('Message Encrypted & Sent', 'success');
      };

      const handleUpdateNote = async () => {
        const updated = notes.map(n => n.id === editingNote ? { ...n, text: editNoteText } : n);
        setNotes(updated);
        setEditingNote(null);
        await saveData('notes', updated);
        showNotif('Record Updated', 'success');
      };

      const handleProfileSave = async () => {
        if (!currentUser) return;
        if (tempProfile.name.length > CONFIG.MAX_NAME_LENGTH) { showNotif('Name too long', 'error'); return; }
        const updated = { ...users, [currentUser]: { ...users[currentUser], ...tempProfile } };
        setUsers(updated);
        setEditingProfile(false);
        await saveData('users', updated);
        showNotif('Identity Updated', 'success');
      };

      const handleChangePassword = async () => {
        if (!currentUser) return;
        const user = users[currentUser];
        if (user.password !== passwordChange.current) { showNotif('Authentication Failed', 'error'); return; }
        if (passwordChange.new !== passwordChange.confirm) { showNotif('Mismatch', 'error'); return; }
        if (passwordChange.new.length < 6) { showNotif('Weak Password', 'error'); return; }
        const updated = { ...users, [currentUser]: { ...users[currentUser], password: passwordChange.new } };
        setUsers(updated);
        setChangingPassword(false);
        setPasswordChange({ current: '', new: '', confirm: '' });
        await saveData('users', updated);
        showNotif('Security Updated', 'success');
      };

      const handlePasswordReset = async () => {
        if (!resetUserId) return;
        if (resetKey !== CONFIG.SPECIAL_KEY) { showNotif('Invalid Key', 'error'); return; }
        if (newPasswordReset !== confirmPasswordReset) { showNotif('Mismatch', 'error'); return; }
        const updated = { ...users, [resetUserId]: { ...users[resetUserId], password: newPasswordReset } };
        setUsers(updated);
        await saveData('users', updated);
        setShowPasswordReset(false);
        setResetUserId(null);
        showNotif('Access Restored', 'success');
      };

      const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
      };

      const formatDate = (iso) => {
        const d = new Date(iso);
        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
      };

      // --- RENDERING ---
      
      if (view === 'loading') {
        return (
          <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-black">
            <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 via-black to-purple-900/20 animate-pulse"></div>
            <div className="text-center relative z-10 animate-fade-in px-4">
              <h1 className="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-gray-400 to-white mb-6 tracking-tighter animate-glow">
                PRIVATE CLOUD
              </h1>
              <div className="w-20 h-1 bg-white/20 mx-auto rounded-full overflow-hidden">
                <div className="w-full h-full bg-white animate-[translateX_1.5s_ease-in-out_infinite]"></div>
              </div>
            </div>
          </div>
        );
      }

      if (showITShareLoading) {
        return (
          <div className="min-h-screen bg-black flex flex-col items-center justify-center animate-fade-in p-8 relative overflow-hidden">
            <div className="absolute inset-0 z-0 opacity-30">
               <div className="absolute top-0 w-full h-1 bg-blue-500 shadow-[0_0_20px_#3b82f6] animate-scan"></div>
            </div>
            <div className="z-10 text-center animate-scale-in w-full max-w-4xl">
              <div className="relative mb-8 inline-block rounded-3xl overflow-hidden shadow-[0_0_50px_rgba(59,130,246,0.5)] border-2 border-blue-500/30 w-full">
                <img src={CONFIG.ITSHARE_LOADING_IMAGE_URL} alt="Loading" className="w-full h-auto object-contain" />
                <div className="absolute inset-0 bg-blue-500/10 mix-blend-overlay"></div>
              </div>
              <h2 className="text-3xl md:text-5xl font-black text-white mb-4 tracking-tight animate-text-pulse">Loading...</h2>
              <p className="text-blue-400 font-mono tracking-widest text-lg md:text-xl">This wont take long..</p>
            </div>
          </div>
        );
      }

      // LOGIN / LOBBY
      if (view === 'login') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-black">
            <Notification notification={notification} />
            <div className="absolute top-[-20%] right-[-10%] w-[800px] h-[800px] bg-white/5 rounded-full blur-[150px]"></div>
            <div className="absolute bottom-[-20%] left-[-10%] w-[800px] h-[800px] bg-blue-600/10 rounded-full blur-[150px]"></div>

            {showPasswordReset ? (
              <div className="w-full max-w-md animate-scale-in z-10">
                <div className="glass-card rounded-[2.5rem] p-6 md:p-10">
                  <button onClick={() => { setShowPasswordReset(false); setResetKey(''); }} className="flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors"><Icons.ArrowLeft /> Back</button>
                  <h2 className="text-3xl font-black text-white mb-8">Override Protocol</h2>
                  <div className="space-y-4">
                    <input type="text" placeholder="Admin Key" value={resetKey} onChange={e => setResetKey(e.target.value)} className="input-field w-full rounded-2xl px-6 py-4 outline-none font-bold" />
                    <input type="password" placeholder="New Sequence" value={newPasswordReset} onChange={e => setNewPasswordReset(e.target.value)} className="input-field w-full rounded-2xl px-6 py-4 outline-none font-bold" />
                    <input type="password" placeholder="Confirm Sequence" value={confirmPasswordReset} onChange={e => setConfirmPasswordReset(e.target.value)} className="input-field w-full rounded-2xl px-6 py-4 outline-none font-bold" />
                  </div>
                  <button onClick={handlePasswordReset} className="w-full mt-8 bg-white text-black rounded-2xl py-4 font-bold hover:scale-[1.02] transition-transform">Execute Reset</button>
                </div>
              </div>
            ) : selectedUser ? (
              <div className="w-full max-w-md animate-slide-up z-10">
                <div className="glass-card rounded-[2.5rem] p-6 md:p-10">
                  <button onClick={() => setSelectedUser(null)} className="flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors"><Icons.ArrowLeft /> Back</button>
                  <div className="flex flex-col items-center mb-8">
                    <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-white/20 shadow-2xl mb-6 animate-float">
                      <img src={users[selectedUser].icon} alt="" className="w-full h-full object-cover" />
                    </div>
                    <h2 className="text-3xl font-black text-white tracking-tight">{users[selectedUser].name}</h2>
                  </div>
                  <input 
                    type="password" 
                    placeholder="Enter Passkey" 
                    value={loginPassword} 
                    onChange={e => setLoginPassword(e.target.value)}
                    onKeyPress={e => e.key === 'Enter' && handleLogin()}
                    autoFocus
                    className="input-field w-full rounded-2xl px-6 py-4 text-lg outline-none font-bold text-center tracking-widest mb-6"
                  />
                  <button onClick={handleLogin} className="w-full bg-white text-black rounded-2xl py-4 font-bold text-lg hover:scale-[1.02] transition-transform shadow-[0_0_20px_rgba(255,255,255,0.2)] mb-4">
                    Authenticate
                  </button>
                  <button onClick={() => { setResetUserId(selectedUser); setShowPasswordReset(true); setSelectedUser(null); }} className="w-full text-gray-500 font-medium hover:text-white transition-colors text-sm">
                    Lost Credentials?
                  </button>
                </div>
              </div>
            ) : (
              <div className="w-full max-w-6xl animate-fade-in z-10">
                <div className="flex flex-col lg:flex-row items-center gap-8 lg:gap-16">
                  <div className="lg:w-5/12 animate-slide-in-right hidden lg:block">
                    <img src={CONFIG.LOBBY_IMAGE_URL} alt="Lobby" className="rounded-[2.5rem] border border-white/10 shadow-2xl w-full rotate-2 hover:rotate-0 transition-transform duration-700 ease-out" />
                  </div>
                  <div className="lg:w-7/12 w-full">
                    <h1 className="text-5xl md:text-8xl font-black text-white mb-6 tracking-tighter animate-slide-down text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-500">
                      PRIVATE<br/>CLOUD
                    </h1>
                    <p className="text-xl md:text-2xl text-gray-400 mb-8 md:mb-12 font-light border-l-4 border-white pl-6 animate-slide-down" style={{animationDelay: '0.1s'}}>
                      Secure Vault Access
                    </p>
                    <div className="grid gap-6">
                      {Object.entries(users).map(([uid, u], i) => (
                        <div key={uid} onClick={() => setSelectedUser(uid)} className="group glass p-4 rounded-3xl cursor-pointer flex items-center gap-6 hover-trigger" style={{ animationDelay: `${i * 0.1}s` }}>
                          <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-white/10 group-hover:border-white transition-colors flex-shrink-0">
                            <img src={u.icon} alt="" className="w-full h-full object-cover" />
                          </div>
                          <div className="flex-1 min-w-0">
                            <h2 className="text-xl md:text-2xl font-bold text-white group-hover:translate-x-2 transition-transform truncate">{u.name}</h2>
                          </div>
                          <div className="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-white group-hover:text-black transition-all flex-shrink-0">
                            <svg className="w-6 h-6 transform -rotate-45 group-hover:rotate-0 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // MAIN APP
      const currentUserData = currentUser ? users[currentUser] : null;
      if (!currentUserData) return null;

      // Define showModal state logic inside App for cleaner passing to ModalBackdrop
      const showEditModal = editingProfile || changingPassword;

      return (
        <div className="min-h-screen bg-black p-4 md:p-8 relative selection:bg-white selection:text-black">
          <Notification notification={notification} />
          <div className="fixed inset-0 pointer-events-none z-0">
             <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-white/5 rounded-full blur-[100px]"></div>
          </div>

          {!showEditModal && (
            <button
              onClick={() => { setShowITShareLoading(true); setTimeout(() => window.location.href = CONFIG.ITSHARE_URL, 3400); }}
              className="fixed top-4 left-4 md:top-6 md:left-6 z-50 glass text-white px-4 py-2 md:px-6 md:py-3 rounded-2xl font-bold text-sm md:text-base hover:bg-white hover:text-black transition-all shadow-2xl animate-glow"
            >
              ITSHARE Converter
            </button>
          )}

          <div className="max-w-7xl mx-auto relative z-10 pt-20 md:pt-24">
            {/* Header */}
            <div className="glass-card rounded-[2.5rem] p-6 md:p-8 shadow-2xl mb-8 animate-slide-down flex flex-col md:flex-row items-center justify-between gap-6">
              <div className="flex flex-col md:flex-row items-center gap-6 w-full md:w-auto text-center md:text-left">
                <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-white/20 shadow-2xl animate-float">
                  <img src={currentUserData.icon} alt="" className="w-full h-full object-cover" />
                </div>
                <div>
                  <h1 className="text-3xl md:text-4xl font-black text-white tracking-tight mb-1">{currentUserData.name}</h1>
                  <div className="flex items-center justify-center md:justify-start gap-2 text-gray-400 font-medium bg-white/5 border border-white/10 px-4 py-1 rounded-full w-fit mx-auto md:mx-0">
                    <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    {(files[currentUser] || []).length} Encrypted Files
                  </div>
                </div>
              </div>

              <div className="flex gap-4 w-full md:w-auto justify-center">
                 <button onClick={() => { setTempProfile({ name: currentUserData.name, icon: currentUserData.icon }); setEditingProfile(true); }} className="p-3 md:p-4 rounded-2xl bg-white/5 border border-white/10 hover:bg-white hover:text-black transition-all hover-trigger"><Icons.User /></button>
                 <button onClick={() => setView(view === 'files' ? 'notes' : 'files')} className="p-3 md:p-4 rounded-2xl bg-white/5 border border-white/10 hover:bg-white hover:text-black transition-all hover-trigger">{view === 'files' ? <Icons.Message /> : <Icons.File />}</button>
                 <button onClick={() => setShowLogoutConfirm(true)} className="p-3 md:p-4 rounded-2xl bg-red-500/10 border border-red-500/50 text-red-500 hover:bg-red-500 hover:text-white transition-all hover-trigger"><Icons.LogOut /></button>
              </div>
            </div>

            {/* Content */}
            <div className="animate-fade-in pb-20 md:pb-0" style={{animationDelay: '0.2s'}}>
              {view === 'files' ? (
                <div className="space-y-6">
                  <div className="glass rounded-[2.5rem] p-4 flex justify-center animate-scale-in">
                    <label className="cursor-pointer group relative overflow-hidden rounded-3xl w-full max-w-md">
                      <div className="bg-white text-black py-6 px-8 font-black text-center flex items-center justify-center gap-4 transition-all group-hover:scale-[1.02] shadow-[0_0_30px_rgba(255,255,255,0.2)]">
                         <div className="w-8 h-8"><Icons.Upload /></div>
                         <span className="text-lg tracking-wide">UPLOAD SECURE FILE</span>
                      </div>
                      <input type="file" onChange={handleFileUpload} className="hidden" />
                    </label>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {(files[currentUser] || []).map((file, i) => (
                      <div key={file.id} className="glass-card rounded-[2rem] p-6 hover-trigger animate-slide-up flex flex-col justify-between h-48 relative overflow-hidden" style={{ animationDelay: `${i * 0.05}s` }}>
                        <div className="relative z-10">
                           <div className="bg-white/10 w-12 h-12 rounded-2xl flex items-center justify-center mb-4 text-white"><Icons.File className="w-6 h-6" /></div>
                           <h3 className="font-bold text-xl text-white line-clamp-1 mb-1">{file.name}</h3>
                           <p className="text-sm text-gray-400 font-medium">{formatSize(file.size)}</p>
                        </div>
                        <div className="flex gap-2 relative z-10 mt-auto">
                           <button onClick={() => { const link = document.createElement('a'); link.href = file.data; link.download = file.name; link.click(); showNotif('Decrypted & Downloaded', 'success'); }} className="flex-1 bg-white text-black py-2 rounded-xl font-bold text-sm hover:bg-gray-200 transition-colors flex items-center justify-center gap-2"><Icons.Download className="w-4 h-4" /> Save</button>
                           <button onClick={() => handleDeleteRequest('file', file.id)} className="w-10 h-10 flex items-center justify-center bg-red-500/20 text-red-400 rounded-xl hover:bg-red-500 hover:text-white transition-colors"><Icons.X className="w-5 h-5" /></button>
                        </div>
                      </div>
                    ))}
                    {(files[currentUser] || []).length === 0 && (
                      <div className="col-span-full py-20 text-center text-gray-500 glass rounded-[3rem] border-dashed animate-scale-in">
                        <p className="text-xl tracking-widest">NO SECURE FILES FOUND</p>
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="flex flex-col lg:grid lg:grid-cols-12 gap-8 h-auto lg:h-[calc(100vh-300px)]">
                   <div className="order-1 lg:order-none lg:col-span-4 glass-card rounded-[2.5rem] p-8 h-auto lg:h-full flex flex-col animate-slide-in-right border border-white/10 shrink-0">
                      <h3 className="text-2xl font-black mb-6 text-white">Encrypted Note</h3>
                      <textarea value={newNote} onChange={e => setNewNote(e.target.value)} placeholder="Type classified info..." className="flex-1 w-full bg-black/50 border border-white/10 focus:border-white rounded-2xl p-4 resize-none outline-none transition-all mb-4 text-lg text-white placeholder-gray-600 min-h-[150px] lg:min-h-0" />
                      <button onClick={handleAddNote} className="w-full bg-white text-black py-4 rounded-2xl font-bold hover:scale-[1.02] active:scale-95 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)]">SEND TO CLOUD</button>
                   </div>
                   
                   <div className="order-2 lg:order-none lg:col-span-8 space-y-4 overflow-y-auto pr-2 pb-4 lg:pb-20 h-[60vh] lg:h-full custom-scrollbar">
                     {notes.length === 0 ? (
                        <div className="glass border-dashed rounded-[2.5rem] h-full flex items-center justify-center text-gray-600 tracking-widest min-h-[200px]">NO TRANSMISSIONS</div>
                     ) : (
                        notes.map((note, i) => (
                          <div key={note.id} className={`p-6 rounded-[2rem] animate-slide-up transition-all hover:translate-y-[-2px] border ${note.userId === currentUser ? 'bg-white text-black ml-4 md:ml-12 border-white' : 'bg-black/40 text-white mr-4 md:mr-12 border-white/10'}`} style={{ animationDelay: `${i * 0.05}s` }}>
                             <div className="flex items-center justify-between mb-2">
                               <span className="font-bold text-sm opacity-50 uppercase tracking-wider">{note.user}</span>
                               <span className="text-xs opacity-50">{formatDate(note.date)}</span>
                             </div>
                             {editingNote === note.id ? (
                               <div className="animate-fade-in">
                                 <textarea value={editNoteText} onChange={e => setEditNoteText(e.target.value)} className="w-full bg-gray-100 text-black border-2 border-black rounded-xl p-3 mb-2 outline-none" autoFocus />
                                 <div className="flex justify-end gap-2">
                                   <button onClick={() => setEditingNote(null)} className="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 rounded-xl">Cancel</button>
                                   <button onClick={handleUpdateNote} className="px-4 py-2 text-sm font-bold bg-black text-white rounded-xl">Save</button>
                                 </div>
                               </div>
                             ) : (
                               <p className="text-lg font-medium whitespace-pre-wrap leading-relaxed">{note.text}</p>
                             )}
                             {note.userId === currentUser && !editingNote && (
                               <div className="flex justify-end gap-3 mt-4 pt-4 border-t border-black/10 opacity-0 hover:opacity-100 transition-opacity">
                                 <button onClick={() => { setEditingNote(note.id); setEditNoteText(note.text); }} className="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"><Icons.Edit /></button>
                                 <button onClick={() => handleDeleteRequest('note', note.id)} className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"><Icons.X /></button>
                               </div>
                             )}
                          </div>
                        ))
                     )}
                   </div>
                </div>
              )}
            </div>
          </div>

          {/* --- MODALS --- */}
          <ConfirmationModal show={showLogoutConfirm} title="Terminate Session?" message="Secure connection will be severed." confirmText="Log Off" onConfirm={handleLogout} onCancel={() => setShowLogoutConfirm(false)} isDanger />
          
          <ConfirmationModal show={showDeleteConfirm} title={deleteStep === 1 ? "Confirm Deletion" : "Final Authorization"} message={deleteStep === 1 ? "Item will be flagged for removal." : "This data cannot be recovered. Proceed?"} confirmText={deleteStep === 1 ? "Delete" : "Obliterate"} onConfirm={proceedDelete} onCancel={() => { setShowDeleteConfirm(false); setDeleteStep(1); }} isDanger />

          <ModalBackdrop show={showStorageWarning} onClose={() => setShowStorageWarning(false)}>
             <div className="text-center text-white">
               <div className="text-6xl mb-4 animate-bounce">⚠️</div>
               <h2 className="text-2xl font-bold mb-2">Capacity Critical</h2>
               <p className="text-gray-400 mb-6">Storage Usage > 80%. System stability at risk.</p>
               <button onClick={() => setShowStorageWarning(false)} className="w-full bg-white text-black py-3 rounded-2xl font-bold">Acknowledge</button>
             </div>
          </ModalBackdrop>

          {/* Edit Profile / Password Modal with Transitions */}
          <ModalBackdrop show={showEditModal} onClose={() => { setEditingProfile(false); setChangingPassword(false); }}>
             {changingPassword ? (
               <div key="password-form" className="animate-slide-up text-white">
                 <h2 className="text-2xl font-bold mb-6">Update Protocol</h2>
                 <div className="space-y-4 mb-6">
                   <input type="password" placeholder="Current Key" value={passwordChange.current} onChange={e => setPasswordChange({...passwordChange, current: e.target.value})} className="input-field w-full rounded-xl p-4 font-bold" />
                   <input type="password" placeholder="New Key" value={passwordChange.new} onChange={e => setPasswordChange({...passwordChange, new: e.target.value})} className="input-field w-full rounded-xl p-4 font-bold" />
                   <input type="password" placeholder="Verify Key" value={passwordChange.confirm} onChange={e => setPasswordChange({...passwordChange, confirm: e.target.value})} className="input-field w-full rounded-xl p-4 font-bold" />
                 </div>
                 <div className="flex gap-4">
                   <button onClick={handleChangePassword} className="flex-1 bg-white text-black py-3 rounded-xl font-bold hover:scale-105 transition-transform">Update</button>
                   <button onClick={() => setChangingPassword(false)} className="flex-1 bg-transparent border border-white/20 text-white py-3 rounded-xl font-bold">Cancel</button>
                 </div>
               </div>
             ) : (
               <div key="profile-form" className="animate-slide-up text-white">
                  <h2 className="text-2xl font-bold mb-6">Modify Profile</h2>
                  <div className="flex justify-center mb-6">
                     <div className="relative group">
                       <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-white/20">
                         <img src={tempProfile.icon} alt="" className="w-full h-full object-cover" />
                       </div>
                       <label className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full cursor-pointer font-bold tracking-widest backdrop-blur-sm">
                         UPLOAD
                         <input type="file" onChange={e => { const f = e.target.files?.[0]; if (f) { const r = new FileReader(); r.onload = ev => setTempProfile({...tempProfile, icon: ev.target?.result}); r.readAsDataURL(f); } }} className="hidden" />
                       </label>
                     </div>
                  </div>
                  <input type="text" value={tempProfile.name} onChange={e => setTempProfile({...tempProfile, name: e.target.value})} maxLength={CONFIG.MAX_NAME_LENGTH} className="input-field w-full p-4 rounded-xl mb-2 font-bold text-center text-xl bg-white text-black" />
                  <p className="text-xs text-center text-gray-500 mb-6">{tempProfile.name.length}/{CONFIG.MAX_NAME_LENGTH}</p>
                  <div className="flex gap-3">
                     <button onClick={handleProfileSave} className="flex-1 bg-white text-black py-3 rounded-xl font-bold hover:scale-105 transition-transform">Save</button>
                     <button onClick={() => { setEditingProfile(false); setChangingPassword(true); }} className="flex-1 bg-transparent border border-white/20 text-white py-3 rounded-xl font-bold hover:bg-white/5">Keys</button>
                  </div>
               </div>
             )}
          </ModalBackdrop>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
